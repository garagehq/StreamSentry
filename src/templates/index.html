<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MINUS</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>MINUS<span class="cursor">_</span></h1>
            <div class="header-controls">
                <div id="connection-status" class="status-dot" title="Connection status"></div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="tab-nav">
            <button class="tab-nav-btn active" onclick="showTab('home')">Home</button>
            <button class="tab-nav-btn" onclick="showTab('remote')">Remote</button>
            <button class="tab-nav-btn" onclick="showTab('screenshots')">Screenshots</button>
            <button class="tab-nav-btn" onclick="showTab('settings')">Settings</button>
        </nav>

        <!-- ===== HOME TAB ===== -->
        <div id="tab-home" class="tab-content active">
            <!-- Live Video -->
            <section class="video-section">
                <div class="video-container" id="video-container">
                    <img id="video-feed" src="/stream" alt="Live Feed">
                    <div id="video-overlay" class="video-overlay hidden">
                        <span>NO SIGNAL</span>
                    </div>
                    <div id="audio-mute-indicator" class="audio-indicator hidden">
                        <span>&#128263;</span>
                    </div>
                    <button id="fullscreen-btn" class="fullscreen-btn" onclick="toggleFullscreen()" title="Fullscreen">&#x26F6;</button>
                </div>
            </section>

            <!-- Status -->
            <section class="status-section">
                <div id="blocking-status" class="blocking-status">
                    <span class="status-label">Status:</span>
                    <span id="status-text" class="status-value">Loading...</span>
                    <span id="blocking-timer" class="blocking-timer hidden"></span>
                </div>
                <div class="status-details">
                    <div class="stat">
                        <span class="stat-label">FPS</span>
                        <span id="fps-value" class="stat-value">--</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Ads Blocked</span>
                        <span id="ads-blocked-value" class="stat-value">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Time Saved</span>
                        <span id="time-saved-value" class="stat-value">0s</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Uptime</span>
                        <span id="uptime-value" class="stat-value">--</span>
                    </div>
                </div>
            </section>

            <!-- Current Vocabulary (shown when blocking) -->
            <section id="vocabulary-section" class="vocabulary-section hidden">
                <h2>Current Word</h2>
                <div class="vocabulary-card">
                    <div id="vocab-word" class="vocab-word">--</div>
                    <div id="vocab-pronunciation" class="vocab-pronunciation"></div>
                    <div id="vocab-translation" class="vocab-translation">--</div>
                    <div id="vocab-example" class="vocab-example"></div>
                </div>
            </section>

            <!-- Pause Controls -->
            <section class="pause-section">
                <div id="pause-controls" class="pause-controls">
                    <span class="pause-label">Pause blocking:</span>
                    <div class="pause-buttons">
                        <button onclick="pauseBlocking(1)" class="pause-btn">1m</button>
                        <button onclick="pauseBlocking(2)" class="pause-btn">2m</button>
                        <button onclick="pauseBlocking(5)" class="pause-btn">5m</button>
                        <button onclick="pauseBlocking(10)" class="pause-btn">10m</button>
                        <input type="number" id="custom-pause" class="custom-pause-input" min="1" max="60" placeholder="min">
                        <button onclick="pauseCustom()" class="pause-btn custom">Go</button>
                    </div>
                </div>
                <div id="resume-controls" class="resume-controls hidden">
                    <div class="paused-info">
                        <span class="paused-icon">&#9208;</span>
                        <span id="pause-remaining">Paused</span>
                    </div>
                    <button onclick="resumeBlocking()" class="resume-btn">Resume Now</button>
                </div>
            </section>

            <!-- Test Controls -->
            <section class="test-section">
                <div class="test-controls">
                    <span class="test-label">Test blocking:</span>
                    <div class="test-buttons">
                        <button onclick="testBlock(10, 'ocr')" class="test-btn">OCR 10s</button>
                        <button onclick="testBlock(10, 'vlm')" class="test-btn">VLM 10s</button>
                        <button onclick="testBlock(20, 'both')" class="test-btn">Both 20s</button>
                        <button onclick="stopTestBlock()" class="test-btn stop">Stop</button>
                    </div>
                </div>
            </section>

            <!-- Recent Detections -->
            <section class="detections-section">
                <h2>Recent Detections</h2>
                <div id="detections-list" class="detections-list">
                    <div class="empty-state">No detections yet</div>
                </div>
            </section>

            <!-- System Info -->
            <section class="system-section">
                <div class="system-info">
                    <span id="vlm-status" class="system-badge">VLM: --</span>
                    <span id="memory-status" class="system-badge">Mem: --</span>
                    <span id="hdmi-status" class="system-badge">HDMI: --</span>
                </div>
            </section>
        </div>

        <!-- ===== REMOTE TAB ===== -->
        <div id="tab-remote" class="tab-content">
            <section class="firetv-section">
                <div class="firetv-header">
                    <h2>Fire TV Remote</h2>
                    <span id="firetv-status" class="connection-badge disconnected">Disconnected</span>
                </div>
                <div class="remote-grid">
                    <div class="remote-row">
                        <button class="remote-btn" onclick="sendFireTVCommand('back')">&#8592; Back</button>
                        <button class="remote-btn nav" onclick="sendFireTVCommand('up')">&#9650;</button>
                        <button class="remote-btn" onclick="sendFireTVCommand('home')">&#8962; Home</button>
                    </div>
                    <div class="remote-row">
                        <button class="remote-btn nav" onclick="sendFireTVCommand('left')">&#9664;</button>
                        <button class="remote-btn select" onclick="sendFireTVCommand('select')">OK</button>
                        <button class="remote-btn nav" onclick="sendFireTVCommand('right')">&#9654;</button>
                    </div>
                    <div class="remote-row">
                        <button class="remote-btn" onclick="sendFireTVCommand('rewind')">&#9194;</button>
                        <button class="remote-btn nav" onclick="sendFireTVCommand('down')">&#9660;</button>
                        <button class="remote-btn" onclick="sendFireTVCommand('fast_forward')">&#9193;</button>
                    </div>
                    <div class="remote-row media">
                        <button class="remote-btn" onclick="sendFireTVCommand('play_pause')">&#9199; Play/Pause</button>
                        <button class="remote-btn" onclick="sendFireTVCommand('menu')">&#9776; Menu</button>
                    </div>
                </div>
            </section>

            <section class="apps-section">
                <h2>Quick Launch</h2>
                <div class="apps-grid">
                    <button class="app-btn" onclick="launchApp('youtube')">YouTube</button>
                    <button class="app-btn" onclick="launchApp('netflix')">Netflix</button>
                    <button class="app-btn" onclick="launchApp('prime')">Prime</button>
                    <button class="app-btn" onclick="launchApp('disney')">Disney+</button>
                    <button class="app-btn" onclick="launchApp('hulu')">Hulu</button>
                    <button class="app-btn" onclick="launchApp('plex')">Plex</button>
                </div>
            </section>
        </div>

        <!-- ===== SCREENSHOTS TAB ===== -->
        <div id="tab-screenshots" class="tab-content">
            <section class="screenshots-section">
                <h2>Screenshots</h2>
                <div class="screenshot-tabs">
                    <button class="tab-btn active" onclick="showScreenshotTab('ads')">Ads</button>
                    <button class="tab-btn" onclick="showScreenshotTab('non_ads')">Non-Ads</button>
                    <button class="tab-btn" onclick="showScreenshotTab('vlm_spastic')">VLM Spastic</button>
                    <button class="tab-btn" onclick="showScreenshotTab('static')">Static</button>
                </div>
                <div id="screenshots-grid" class="screenshots-grid">
                    <div class="empty-state">Select a tab to load</div>
                </div>
                <div id="screenshots-pagination" class="pagination hidden">
                    <button onclick="loadScreenshotsPage(currentScreenshotPage - 1)" id="prev-page-btn" class="page-btn" disabled>&laquo; Prev</button>
                    <span id="page-info" class="page-info">Page 1 of 1</span>
                    <button onclick="loadScreenshotsPage(currentScreenshotPage + 1)" id="next-page-btn" class="page-btn">Next &raquo;</button>
                </div>
                <div id="screenshots-total" class="screenshots-total"></div>
            </section>
        </div>

        <!-- ===== SETTINGS TAB ===== -->
        <div id="tab-settings" class="tab-content">
            <!-- Display Settings -->
            <section class="settings-section">
                <h2>Display Settings</h2>
                <div class="setting-item">
                    <span class="setting-label">Ad Preview Window</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="preview-toggle" checked onchange="togglePreview(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Debug Dashboard</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="debug-toggle" checked onchange="toggleDebugOverlay(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Browser Notifications</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notifications-toggle" onchange="toggleNotifications(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </section>

            <!-- Fire TV Settings -->
            <section class="settings-section">
                <h2>Fire TV Settings</h2>
                <div class="setting-item">
                    <span class="setting-label">Keep-Alive Pings</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="keepalive-toggle" onchange="toggleKeepalive(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <p class="help-text">Sends periodic pings to prevent Fire TV ADB disconnects (every ~5 minutes with jitter).</p>
            </section>

            <!-- WiFi Management -->
            <section class="wifi-section">
                <h2>WiFi Networks</h2>
                <div class="wifi-tabs">
                    <button class="tab-btn active" onclick="showWifiTab('saved')">Saved</button>
                    <button class="tab-btn" onclick="showWifiTab('scan')">Scan</button>
                </div>
                <div id="wifi-saved" class="wifi-list">
                    <div class="empty-state">Loading...</div>
                </div>
                <div id="wifi-scan" class="wifi-list hidden">
                    <button onclick="scanWifi()" class="scan-btn">Scan for Networks</button>
                    <div id="wifi-scan-results"></div>
                </div>
            </section>

            <!-- Network Info -->
            <section class="network-section">
                <h2>Network</h2>
                <div id="network-info" class="network-info">
                    <div class="empty-state">Loading...</div>
                </div>
            </section>

            <!-- ADB Keys -->
            <section class="adb-section">
                <h2>ADB Keys (Fire TV)</h2>
                <div id="adb-key-info" class="adb-key-info">
                    <div class="empty-state">Loading...</div>
                </div>
                <div class="adb-actions">
                    <button onclick="copyFingerprint()" class="action-btn" id="copy-fp-btn">Copy Fingerprint</button>
                    <button onclick="revokeAdbKeys()" class="danger-btn">Revoke Keys</button>
                </div>
                <p class="help-text">Revoking keys will require re-authorization on the Fire TV.</p>
            </section>

            <!-- Service Controls -->
            <section class="service-section">
                <h2>Service</h2>
                <div class="service-actions">
                    <button onclick="restartService()" class="warning-btn">Restart Service</button>
                    <button onclick="clearDetections()" class="action-btn">Clear Detections</button>
                </div>
                <p class="help-text">Restarting will briefly interrupt video output.</p>
            </section>

            <!-- Logs -->
            <section class="logs-section">
                <h2>Logs</h2>
                <div id="logs-content" class="logs-content">
                    Loading logs...
                </div>
                <button onclick="refreshLogs()" class="refresh-btn">Refresh Logs</button>
            </section>
        </div>

        <!-- Keyboard Shortcuts Help -->
        <div id="shortcuts-help" class="shortcuts-help hidden">
            <h3>Keyboard Shortcuts</h3>
            <ul>
                <li><kbd>P</kbd> Pause (5 min)</li>
                <li><kbd>R</kbd> Resume</li>
                <li><kbd>T</kbd> Test block</li>
                <li><kbd>F</kbd> Fullscreen</li>
                <li><kbd>?</kbd> Show shortcuts</li>
                <li><kbd>Esc</kbd> Close dialogs</li>
            </ul>
        </div>
    </div>

    <!-- System Footer -->
    <footer class="system-footer">
        <span class="footer-item" id="footer-version">MINUS v1.0</span>
        <span class="footer-separator">|</span>
        <span class="footer-item" id="footer-host">--</span>
        <span class="footer-separator">|</span>
        <span class="footer-item"><span class="blink">‚óè</span> <span id="footer-status">INITIALIZING</span></span>
    </footer>

    <!-- WiFi Password Modal -->
    <div id="wifi-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Connect to <span id="wifi-modal-ssid"></span></h3>
            <input type="password" id="wifi-password" placeholder="Password" class="modal-input">
            <div class="modal-buttons">
                <button onclick="closeWifiModal()" class="modal-btn cancel">Cancel</button>
                <button onclick="connectWifi()" class="modal-btn confirm">Connect</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let isPaused = false;
        let pauseRemaining = 0;
        let lastStatus = null;
        let currentScreenshotTab = 'ads';
        let currentWifiTab = 'saved';
        let notificationsEnabled = false;
        let pendingWifiSSID = null;
        let currentTab = 'home';

        // =========================================================================
        // Tab Navigation
        // =========================================================================

        function showTab(tabName) {
            currentTab = tabName;

            // Update nav buttons
            document.querySelectorAll('.tab-nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase() === tabName);
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === 'tab-' + tabName);
            });

            // Load data for specific tabs
            if (tabName === 'screenshots') {
                loadScreenshots();
            } else if (tabName === 'settings') {
                loadWifiConnections();
                loadAdbKeys();
                loadNetworkInfo();
                refreshLogs();
            } else if (tabName === 'remote') {
                updateFireTVStatus();
            }
        }

        // =========================================================================
        // Status Updates
        // =========================================================================

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) throw new Error('Status fetch failed');

                const status = await response.json();
                lastStatus = status;

                // Connection indicator
                document.getElementById('connection-status').classList.remove('disconnected');
                document.getElementById('connection-status').classList.add('connected');

                // Blocking status
                const statusEl = document.getElementById('blocking-status');
                const statusText = document.getElementById('status-text');
                const blockingTimer = document.getElementById('blocking-timer');
                const vocabSection = document.getElementById('vocabulary-section');

                if (status.paused) {
                    statusEl.className = 'blocking-status paused';
                    const mins = Math.floor(status.pause_remaining / 60);
                    const secs = status.pause_remaining % 60;
                    statusText.textContent = `PAUSED (${mins}:${secs.toString().padStart(2, '0')})`;
                    isPaused = true;
                    pauseRemaining = status.pause_remaining;
                    blockingTimer.classList.add('hidden');
                    vocabSection.classList.add('hidden');
                } else if (status.blocking) {
                    statusEl.className = 'blocking-status blocking';
                    const source = status.blocking_source ? status.blocking_source.toUpperCase() : '';
                    statusText.textContent = `BLOCKING${source ? ' (' + source + ')' : ''}`;
                    isPaused = false;
                    blockingTimer.classList.remove('hidden');
                    vocabSection.classList.remove('hidden');

                    // Send notification
                    if (notificationsEnabled && Notification.permission === 'granted') {
                        new Notification('Minus - Ad Detected', { body: `Blocking via ${source}` });
                    }
                } else {
                    statusEl.className = 'blocking-status normal';
                    statusText.textContent = 'Normal';
                    isPaused = false;
                    blockingTimer.classList.add('hidden');
                    vocabSection.classList.add('hidden');
                }

                // Update pause/resume visibility
                document.getElementById('pause-controls').classList.toggle('hidden', isPaused);
                document.getElementById('resume-controls').classList.toggle('hidden', !isPaused);
                if (isPaused) {
                    const mins = Math.floor(pauseRemaining / 60);
                    const secs = pauseRemaining % 60;
                    document.getElementById('pause-remaining').textContent =
                        `Paused: ${mins}:${secs.toString().padStart(2, '0')} remaining`;
                }

                // Stats
                document.getElementById('fps-value').textContent = Math.round(status.fps) || '--';
                document.getElementById('uptime-value').textContent = status.uptime_str || '--';

                // Video overlay
                const overlay = document.getElementById('video-overlay');
                if (!status.hdmi_signal) {
                    overlay.classList.remove('hidden');
                } else {
                    overlay.classList.add('hidden');
                }

                // System info
                const vlmStatus = document.getElementById('vlm-status');
                if (status.vlm_disabled) {
                    vlmStatus.textContent = 'VLM: Disabled';
                    vlmStatus.className = 'system-badge warning';
                } else if (status.vlm_ready) {
                    vlmStatus.textContent = 'VLM: Ready';
                    vlmStatus.className = 'system-badge ok';
                } else {
                    vlmStatus.textContent = 'VLM: Loading';
                    vlmStatus.className = 'system-badge loading';
                }

                const memStatus = document.getElementById('memory-status');
                const memPercent = Math.round(status.memory_percent || 0);
                memStatus.textContent = `Mem: ${memPercent}%`;
                memStatus.className = memPercent > 80 ? 'system-badge warning' : 'system-badge ok';

                const hdmiStatus = document.getElementById('hdmi-status');
                hdmiStatus.textContent = status.hdmi_signal ? 'HDMI: OK' : 'HDMI: No Signal';
                hdmiStatus.className = status.hdmi_signal ? 'system-badge ok' : 'system-badge warning';

                // Footer status
                const footerStatus = document.getElementById('footer-status');
                if (status.blocking) {
                    footerStatus.textContent = 'BLOCKING';
                    footerStatus.className = 'status-blocking';
                } else if (status.paused) {
                    footerStatus.textContent = 'PAUSED';
                    footerStatus.className = 'status-paused';
                } else {
                    footerStatus.textContent = 'MONITORING';
                    footerStatus.className = 'status-ok';
                }

            } catch (error) {
                console.error('Status update failed:', error);
                document.getElementById('connection-status').classList.remove('connected');
                document.getElementById('connection-status').classList.add('disconnected');
            }
        }

        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                if (!response.ok) return;

                const stats = await response.json();
                document.getElementById('ads-blocked-value').textContent = stats.ads_blocked_today || '0';

                // Format time saved
                const timeSaved = Math.round(stats.time_saved || 0);
                if (timeSaved >= 3600) {
                    const h = Math.floor(timeSaved / 3600);
                    const m = Math.floor((timeSaved % 3600) / 60);
                    document.getElementById('time-saved-value').textContent = `${h}h ${m}m`;
                } else if (timeSaved >= 60) {
                    const m = Math.floor(timeSaved / 60);
                    const s = timeSaved % 60;
                    document.getElementById('time-saved-value').textContent = `${m}m ${s}s`;
                } else {
                    document.getElementById('time-saved-value').textContent = `${timeSaved}s`;
                }

                // Update blocking timer
                if (stats.current_blocking_duration > 0) {
                    const duration = Math.round(stats.current_blocking_duration);
                    document.getElementById('blocking-timer').textContent = `(${duration}s)`;
                }
            } catch (error) {
                console.error('Stats update failed:', error);
            }
        }

        async function updateVocabulary() {
            try {
                const response = await fetch('/api/vocabulary');
                if (!response.ok) return;

                const vocab = await response.json();
                if (vocab.word) {
                    document.getElementById('vocab-word').textContent = vocab.word;
                    document.getElementById('vocab-pronunciation').textContent = vocab.pronunciation ? `(${vocab.pronunciation})` : '';
                    document.getElementById('vocab-translation').textContent = `= ${vocab.translation}`;
                    document.getElementById('vocab-example').textContent = vocab.example || '';
                }
            } catch (error) {
                console.error('Vocabulary update failed:', error);
            }
        }

        async function updateAudioStatus() {
            try {
                const response = await fetch('/api/audio/status');
                if (!response.ok) return;

                const data = await response.json();
                const indicator = document.getElementById('audio-mute-indicator');
                if (data.muted) {
                    indicator.classList.remove('hidden');
                } else {
                    indicator.classList.add('hidden');
                }
            } catch (error) {
                console.error('Audio status update failed:', error);
            }
        }

        async function updateFireTVStatus() {
            try {
                const response = await fetch('/api/firetv/status');
                if (!response.ok) return;

                const data = await response.json();
                const badge = document.getElementById('firetv-status');
                if (data.connected) {
                    badge.textContent = 'Connected';
                    badge.className = 'connection-badge connected';
                } else {
                    badge.textContent = data.state === 'not_initialized' ? 'Not Setup' : 'Disconnected';
                    badge.className = 'connection-badge disconnected';
                }
            } catch (error) {
                console.error('Fire TV status update failed:', error);
            }
        }

        // =========================================================================
        // Detections
        // =========================================================================

        async function updateDetections() {
            try {
                const response = await fetch('/api/detections');
                if (!response.ok) throw new Error('Detections fetch failed');

                const data = await response.json();
                const list = document.getElementById('detections-list');

                if (data.detections && data.detections.length > 0) {
                    list.innerHTML = data.detections.slice(0, 10).map(d => {
                        const keywords = d.keywords && d.keywords.length > 0
                            ? d.keywords.join(', ')
                            : (d.texts && d.texts[0] ? d.texts[0].substring(0, 40) : 'detected');
                        return `<div class="detection-item">
                            <span class="detection-time">${d.time}</span>
                            <span class="detection-source ${d.source.toLowerCase()}">${d.source}</span>
                            <span class="detection-text">${keywords}</span>
                        </div>`;
                    }).join('');
                } else {
                    list.innerHTML = '<div class="empty-state">No detections yet</div>';
                }
            } catch (error) {
                console.error('Detections update failed:', error);
            }
        }

        // =========================================================================
        // Pause Controls
        // =========================================================================

        async function pauseBlocking(minutes) {
            try {
                const response = await fetch(`/api/pause/${minutes}`, { method: 'POST' });
                if (!response.ok) throw new Error('Pause failed');
                isPaused = true;
                pauseRemaining = minutes * 60;
                updateStatus();
            } catch (error) {
                console.error('Pause failed:', error);
                alert('Failed to pause blocking');
            }
        }

        function pauseCustom() {
            const input = document.getElementById('custom-pause');
            const minutes = parseInt(input.value);
            if (minutes >= 1 && minutes <= 60) {
                pauseBlocking(minutes);
                input.value = '';
            } else {
                alert('Enter 1-60 minutes');
            }
        }

        async function resumeBlocking() {
            try {
                const response = await fetch('/api/resume', { method: 'POST' });
                if (!response.ok) throw new Error('Resume failed');
                isPaused = false;
                updateStatus();
            } catch (error) {
                console.error('Resume failed:', error);
                alert('Failed to resume blocking');
            }
        }

        // =========================================================================
        // Test Controls
        // =========================================================================

        async function testBlock(duration, source) {
            try {
                const response = await fetch('/api/test/trigger-block', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duration, source })
                });
                if (!response.ok) throw new Error('Test block failed');
            } catch (error) {
                console.error('Test block failed:', error);
                alert('Failed to trigger test block');
            }
        }

        async function stopTestBlock() {
            try {
                const response = await fetch('/api/test/stop-block', { method: 'POST' });
                if (!response.ok) throw new Error('Stop test failed');
            } catch (error) {
                console.error('Stop test failed:', error);
            }
        }

        // =========================================================================
        // Fire TV Remote
        // =========================================================================

        async function sendFireTVCommand(command) {
            try {
                const response = await fetch('/api/firetv/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command })
                });
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Command failed');
                }
            } catch (error) {
                console.error('Fire TV command failed:', error);
            }
        }

        // =========================================================================
        // Settings Toggles
        // =========================================================================

        async function togglePreview(enabled) {
            try {
                const endpoint = enabled ? '/api/preview/enable' : '/api/preview/disable';
                const response = await fetch(endpoint, { method: 'POST' });
                if (!response.ok) throw new Error('Preview toggle failed');
            } catch (error) {
                console.error('Preview toggle failed:', error);
                document.getElementById('preview-toggle').checked = !enabled;
            }
        }

        async function toggleDebugOverlay(enabled) {
            try {
                const endpoint = enabled ? '/api/debug-overlay/enable' : '/api/debug-overlay/disable';
                const response = await fetch(endpoint, { method: 'POST' });
                if (!response.ok) throw new Error('Debug overlay toggle failed');
            } catch (error) {
                console.error('Debug overlay toggle failed:', error);
                document.getElementById('debug-toggle').checked = !enabled;
            }
        }

        function toggleNotifications(enabled) {
            if (enabled && Notification.permission !== 'granted') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        notificationsEnabled = true;
                        localStorage.setItem('notificationsEnabled', 'true');
                    } else {
                        document.getElementById('notifications-toggle').checked = false;
                    }
                });
            } else {
                notificationsEnabled = enabled;
                localStorage.setItem('notificationsEnabled', enabled ? 'true' : 'false');
            }
        }

        async function fetchPreviewState() {
            try {
                const response = await fetch('/api/preview');
                if (!response.ok) return;
                const data = await response.json();
                document.getElementById('preview-toggle').checked = data.preview_enabled;
            } catch (error) {
                console.error('Preview state fetch failed:', error);
            }
        }

        async function fetchDebugOverlayState() {
            try {
                const response = await fetch('/api/debug-overlay');
                if (!response.ok) return;
                const data = await response.json();
                document.getElementById('debug-toggle').checked = data.debug_overlay_enabled;
            } catch (error) {
                console.error('Debug overlay state fetch failed:', error);
            }
        }

        async function toggleKeepalive(enabled) {
            try {
                const endpoint = enabled ? '/api/firetv-keepalive/enable' : '/api/firetv-keepalive/disable';
                const response = await fetch(endpoint, { method: 'POST' });
                if (!response.ok) throw new Error('Keep-alive toggle failed');
            } catch (error) {
                console.error('Keep-alive toggle failed:', error);
                document.getElementById('keepalive-toggle').checked = !enabled;
            }
        }

        async function fetchKeepaliveState() {
            try {
                const response = await fetch('/api/firetv-keepalive');
                if (!response.ok) return;
                const data = await response.json();
                document.getElementById('keepalive-toggle').checked = data.keepalive_enabled;
            } catch (error) {
                console.error('Keep-alive state fetch failed:', error);
            }
        }

        // =========================================================================
        // Screenshots (with pagination)
        // =========================================================================

        let currentScreenshotPage = 1;
        let screenshotTotalPages = 1;

        async function loadScreenshots() {
            currentScreenshotPage = 1;
            await loadScreenshotsPage(1);
        }

        async function loadScreenshotsPage(page) {
            if (page < 1) return;

            try {
                const response = await fetch(`/api/screenshots?type=${currentScreenshotTab}&page=${page}&limit=5`);
                if (!response.ok) return;

                const data = await response.json();
                const grid = document.getElementById('screenshots-grid');
                const pagination = document.getElementById('screenshots-pagination');
                const totalEl = document.getElementById('screenshots-total');

                currentScreenshotPage = data.page;
                screenshotTotalPages = data.pages;

                if (data.screenshots && data.screenshots.length > 0) {
                    grid.innerHTML = data.screenshots.map(s =>
                        `<div class="screenshot-item" onclick="window.open('${s.path}', '_blank')">
                            <img src="${s.path}" alt="${s.name}" loading="lazy">
                            <span class="screenshot-name">${s.name.substring(0, 20)}...</span>
                        </div>`
                    ).join('');

                    // Update pagination
                    pagination.classList.remove('hidden');
                    document.getElementById('page-info').textContent = `Page ${data.page} of ${data.pages}`;
                    document.getElementById('prev-page-btn').disabled = data.page <= 1;
                    document.getElementById('next-page-btn').disabled = !data.has_more;
                    totalEl.textContent = `${data.total} total screenshots`;
                } else {
                    grid.innerHTML = '<div class="empty-state">No screenshots</div>';
                    pagination.classList.add('hidden');
                    totalEl.textContent = '';
                }
            } catch (error) {
                console.error('Screenshots load failed:', error);
            }
        }

        function showScreenshotTab(tab) {
            currentScreenshotTab = tab;
            currentScreenshotPage = 1;
            // Map tab names to button text
            const tabToText = {
                'ads': 'ads',
                'non_ads': 'non-ads',
                'vlm_spastic': 'vlm spastic',
                'static': 'static'
            };
            document.querySelectorAll('.screenshots-section .tab-btn').forEach(btn => {
                const btnText = btn.textContent.toLowerCase();
                btn.classList.toggle('active', btnText === tabToText[tab]);
            });
            loadScreenshots();
        }

        // =========================================================================
        // WiFi Management
        // =========================================================================

        async function loadWifiConnections() {
            try {
                const response = await fetch('/api/wifi/connections');
                if (!response.ok) return;

                const data = await response.json();
                const list = document.getElementById('wifi-saved');

                if (data.connections && data.connections.length > 0) {
                    list.innerHTML = data.connections.map(c =>
                        `<div class="wifi-item ${c.device ? 'connected' : ''}">
                            <div class="wifi-info">
                                <span class="wifi-name">${c.name}</span>
                                <span class="wifi-details">Priority: ${c.priority} ${c.device ? '(Connected)' : ''}</span>
                            </div>
                            <div class="wifi-actions">
                                <button onclick="deleteWifiConnection('${c.name}')" class="small-btn danger">Delete</button>
                            </div>
                        </div>`
                    ).join('');
                } else {
                    list.innerHTML = '<div class="empty-state">No saved WiFi connections</div>';
                }
            } catch (error) {
                console.error('WiFi connections load failed:', error);
            }
        }

        async function scanWifi() {
            const results = document.getElementById('wifi-scan-results');
            results.innerHTML = '<div class="empty-state">Scanning...</div>';

            try {
                const response = await fetch('/api/wifi/scan');
                if (!response.ok) throw new Error('Scan failed');

                const data = await response.json();
                if (data.networks && data.networks.length > 0) {
                    results.innerHTML = data.networks.map(n =>
                        `<div class="wifi-item" onclick="promptWifiConnect('${n.ssid}', '${n.security}')">
                            <div class="wifi-info">
                                <span class="wifi-name">${n.ssid}</span>
                                <span class="wifi-details">${n.signal}% - ${n.security}</span>
                            </div>
                        </div>`
                    ).join('');
                } else {
                    results.innerHTML = '<div class="empty-state">No networks found</div>';
                }
            } catch (error) {
                console.error('WiFi scan failed:', error);
                results.innerHTML = '<div class="error-state">Scan failed</div>';
            }
        }

        function promptWifiConnect(ssid, security) {
            if (security === 'Open' || security === '') {
                connectWifiDirect(ssid, '');
            } else {
                pendingWifiSSID = ssid;
                document.getElementById('wifi-modal-ssid').textContent = ssid;
                document.getElementById('wifi-password').value = '';
                document.getElementById('wifi-modal').classList.remove('hidden');
            }
        }

        function closeWifiModal() {
            document.getElementById('wifi-modal').classList.add('hidden');
            pendingWifiSSID = null;
        }

        async function connectWifi() {
            const password = document.getElementById('wifi-password').value;
            await connectWifiDirect(pendingWifiSSID, password);
            closeWifiModal();
        }

        async function connectWifiDirect(ssid, password) {
            try {
                const response = await fetch('/api/wifi/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ssid, password })
                });
                const data = await response.json();
                if (response.ok) {
                    alert(data.message || 'Connected!');
                    loadWifiConnections();
                } else {
                    alert(data.error || 'Connection failed');
                }
            } catch (error) {
                console.error('WiFi connect failed:', error);
                alert('Connection failed');
            }
        }

        async function deleteWifiConnection(name) {
            if (!confirm(`Delete "${name}"?`)) return;

            try {
                const response = await fetch('/api/wifi/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (response.ok) {
                    loadWifiConnections();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Delete failed');
                }
            } catch (error) {
                console.error('WiFi delete failed:', error);
            }
        }

        function showWifiTab(tab) {
            currentWifiTab = tab;
            document.querySelectorAll('.wifi-section .tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase() === tab);
            });
            document.getElementById('wifi-saved').classList.toggle('hidden', tab !== 'saved');
            document.getElementById('wifi-scan').classList.toggle('hidden', tab !== 'scan');
            if (tab === 'saved') loadWifiConnections();
        }

        // =========================================================================
        // ADB Keys
        // =========================================================================

        async function loadAdbKeys() {
            try {
                const response = await fetch('/api/adb/keys');
                if (!response.ok) return;

                const data = await response.json();
                const info = document.getElementById('adb-key-info');

                if (data.exists) {
                    currentFingerprint = data.fingerprint;
                    info.innerHTML = `
                        <div class="adb-key-item">
                            <span class="key-label">Status:</span>
                            <span class="key-value ok">Keys exist</span>
                        </div>
                        <div class="adb-key-item">
                            <span class="key-label">Fingerprint:</span>
                            <span class="key-value mono">${data.fingerprint}</span>
                        </div>
                    `;
                } else {
                    currentFingerprint = null;
                    info.innerHTML = '<div class="empty-state">No ADB keys found</div>';
                }
            } catch (error) {
                console.error('ADB keys load failed:', error);
            }
        }

        async function revokeAdbKeys() {
            if (!confirm('Revoke ADB keys? You will need to re-authorize on the Fire TV.')) return;

            try {
                const response = await fetch('/api/adb/keys/revoke', { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    alert(data.message);
                    loadAdbKeys();
                    updateFireTVStatus();
                } else {
                    alert(data.error || 'Revoke failed');
                }
            } catch (error) {
                console.error('ADB revoke failed:', error);
                alert('Revoke failed');
            }
        }

        let currentFingerprint = null;

        async function copyFingerprint() {
            if (currentFingerprint) {
                try {
                    await navigator.clipboard.writeText(currentFingerprint);
                    const btn = document.getElementById('copy-fp-btn');
                    btn.textContent = 'Copied!';
                    setTimeout(() => { btn.textContent = 'Copy Fingerprint'; }, 2000);
                } catch (error) {
                    alert('Copy failed');
                }
            }
        }

        // =========================================================================
        // Network Info
        // =========================================================================

        async function loadNetworkInfo() {
            try {
                const response = await fetch('/api/network');
                if (!response.ok) return;

                const data = await response.json();
                const info = document.getElementById('network-info');

                let html = `<div class="network-item"><span class="net-label">Hostname:</span><span class="net-value">${data.hostname}</span></div>`;

                if (data.interfaces && data.interfaces.length > 0) {
                    data.interfaces.forEach(iface => {
                        html += `<div class="network-item"><span class="net-label">${iface.interface}:</span><span class="net-value">${iface.ip}</span></div>`;
                    });
                }

                info.innerHTML = html;
            } catch (error) {
                console.error('Network info load failed:', error);
            }
        }

        // =========================================================================
        // Service Controls
        // =========================================================================

        async function restartService() {
            if (!confirm('Restart the Minus service? Video will briefly stop.')) return;

            try {
                const response = await fetch('/api/service/restart', { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    alert('Service restart scheduled. Page will reload in 5 seconds...');
                    setTimeout(() => { location.reload(); }, 5000);
                } else {
                    alert(data.error || 'Restart failed');
                }
            } catch (error) {
                console.error('Service restart failed:', error);
                alert('Restart failed');
            }
        }

        async function clearDetections() {
            if (!confirm('Clear all detection history?')) return;

            try {
                const response = await fetch('/api/detections/clear', { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    updateDetections();
                } else {
                    alert(data.error || 'Clear failed');
                }
            } catch (error) {
                console.error('Clear detections failed:', error);
            }
        }

        // =========================================================================
        // Fire TV App Launch
        // =========================================================================

        async function launchApp(app) {
            try {
                const response = await fetch(`/api/firetv/launch/${app}`, { method: 'POST' });
                const data = await response.json();
                if (!response.ok) {
                    console.error('App launch failed:', data.error);
                }
            } catch (error) {
                console.error('App launch failed:', error);
            }
        }

        // =========================================================================
        // Logs
        // =========================================================================

        async function refreshLogs() {
            try {
                const response = await fetch('/api/logs');
                if (!response.ok) throw new Error('Logs fetch failed');

                const data = await response.json();
                const content = document.getElementById('logs-content');

                if (data.lines && data.lines.length > 0) {
                    content.innerHTML = data.lines.slice(-50).map(line =>
                        `<div class="log-line">${escapeHtml(line)}</div>`
                    ).join('');
                    content.scrollTop = content.scrollHeight;
                } else {
                    content.innerHTML = '<div class="empty-state">No logs available</div>';
                }
            } catch (error) {
                console.error('Logs fetch failed:', error);
                document.getElementById('logs-content').innerHTML =
                    '<div class="error-state">Failed to load logs</div>';
            }
        }

        // =========================================================================
        // UI Helpers
        // =========================================================================

        function toggleFullscreen() {
            const container = document.getElementById('video-container');
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                container.requestFullscreen();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // =========================================================================
        // Keyboard Shortcuts
        // =========================================================================

        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;

            switch (e.key.toLowerCase()) {
                case 'p':
                    if (!isPaused) pauseBlocking(5);
                    break;
                case 'r':
                    if (isPaused) resumeBlocking();
                    break;
                case 't':
                    testBlock(10, 'ocr');
                    break;
                case 'f':
                    toggleFullscreen();
                    break;
                case '?':
                    document.getElementById('shortcuts-help').classList.toggle('hidden');
                    break;
                case 'escape':
                    document.getElementById('shortcuts-help').classList.add('hidden');
                    document.getElementById('wifi-modal').classList.add('hidden');
                    break;
            }
        });

        // =========================================================================
        // Pull to Refresh (Mobile)
        // =========================================================================

        let touchStartY = 0;
        document.addEventListener('touchstart', (e) => { touchStartY = e.touches[0].clientY; });
        document.addEventListener('touchend', (e) => {
            const touchEndY = e.changedTouches[0].clientY;
            if (touchEndY - touchStartY > 100 && window.scrollY === 0) {
                updateStatus();
                updateStats();
                updateDetections();
            }
        });

        // =========================================================================
        // Video Feed Error Handling
        // =========================================================================

        document.getElementById('video-feed').onerror = function() {
            setTimeout(() => { this.src = '/stream?' + Date.now(); }, 2000);
        };

        // =========================================================================
        // Initialization
        // =========================================================================

        notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true';
        document.getElementById('notifications-toggle').checked = notificationsEnabled;

        // Initialize footer hostname
        fetch('/api/network').then(r => r.json()).then(data => {
            document.getElementById('footer-host').textContent = data.hostname || 'unknown';
        }).catch(() => {});

        updateStatus();
        updateStats();
        updateDetections();
        fetchPreviewState();
        fetchDebugOverlayState();
        fetchKeepaliveState();
        updateFireTVStatus();

        setInterval(updateStatus, 1000);
        setInterval(updateStats, 2000);
        setInterval(updateDetections, 5000);
        setInterval(updateVocabulary, 3000);
        setInterval(updateAudioStatus, 2000);
    </script>
</body>
</html>
